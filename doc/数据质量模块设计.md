# 数据质量模块设计

## 介绍

围绕完整性、准确性、一致性、及时性监控分析数据质量问题、提升企业数据质量。
从数据接入、数据加工、数据导出、指标、数据应用实现全链路血缘跟踪、提前预判数据是否能够准时产出、了解任务失败后影响分析以及快速地修复。

基于**工作表数据**进行数据质量监控，通过规则定义和**spark作业**计算，将监控结果写入**mysql**中。最终在**监控页面**对结果进行展示。并且在**工作流**中可以引入**数据质量任务**进行**依赖作业的熔断处理**。

![img](https://bigdata.163yun.com/images/middlePlatform/product-4-detail@2x.jpg)

## 数据质量评估

![image-20200623101737575](http://image-picgo.test.upcdn.net/img/20200623101737.png)



## 模块设计

### 规则模板库

包含模板名，规则代码。

####  非空非null

```sql
${COLUMN} IS NOT NULL AND LENGTH(${COLUMN}) > 0
```





### 监控规则

#### 试跑



#### 关联工作流任务



#### 基础信息

![img](https://nos.netease.com/cloud-website-bucket/201809191610343b5dbf7c-ae59-4096-8ae6-7225d17715a3.png)





#### 创建监控规则

##### 表级别

1. 表行数

2. 表文件大小

   



##### 字段级别

1. 模板模式

   ![image-20200623144141912](http://image-picgo.test.upcdn.net/img/20200623144141.png)

2. 自定义模式

   主要针对复杂场景，多个字段。

   

   SQL结果一定要是数值，否则报错提示。如下面就是正确例子：

   ```SQL
   select count(1) from ( select count(1) from yibo.ods_user_info_d WHERE dt = '20200621' group by gender )
   ```



#### 监控规则删除、更新



### 监控任务查询

任务概览查询

![image-20200623105240735](http://image-picgo.test.upcdn.net/img/20200623105240.png)

任务实例查询

![image-20200623105219549](http://image-picgo.test.upcdn.net/img/20200623105219.png)

任务历史校验结果查询

![image-20200623105449783](http://image-picgo.test.upcdn.net/img/20200623105449.png)

自定义sql任务结果查询

![image-20200630152902933](http://image-picgo.test.upcdn.net/img/20200630152903.png)



### 规则指标

​    数据质量监控指标从有效性、唯一性、完整性、准确性、一致性、有效性、时效性和自定义监控规则八大类，约20条监控规则指标。以下对各个监控指标做出解释。

- **有效性**

- -  **字段长度有效**

    对字段内容长度是否在有效性范围的监控指标，可配置[最小长度，最    大长度]。如mobile手机号11位；身份证18位或15位是否满足配置监控长度，不等于配置长度范围，视为脏数据。

- -  **字段内容有效**

    对字段内容是否在满足正则表达式指定内容格式的监控指标。如对name姓名含有中英文结合；身份证号含有中文；手机号11111111111等异常数据监控。

  -  **字段数值范围有效**

    对数值类型字段是否在有效性值范围的监控指标，可根据业务场景配置该字段值范围[最小值，最大值]。如age年龄，超过1000岁等。

  -  **枚举值个数有效**

    对枚举值字段的可枚举值种类个数的监控指标，可配置[>、>=、=、<=、<、!=]与期望值的比较。如银行储值卡在“消费、转账、提现”三种业务类型，枚举值个数某天少了一种或多种业务类型，可能是上游业务系统出现问题，或数据采集时丢失数据。

  -  **枚举值集合有效**

    对枚举值字段的可枚举值种类内容集合的监控指标，可配置“包含、相等、不包含”与期望值集合的比较。如银行储值卡在“消费、转账、提现”三种业务类型，出现了“消费、转账、贷款”三种业务类型，虽然枚举值个数也是3种，但是枚举值内容有误。

- **唯一性**

- -  **是否重复**

    对主键是否存在重复数据的监控指标。出现重复数据导致重复计算等问题，也支持联合主键唯一性监控。

- **完整性**

- -  **字段是否为空或NULL**

    对字段内容是否存NULL的监控指标。

  -  **记录数是否丢失**

    表级别质量监控指标，判断是否记录是否丢失或无数据，可配置[>、>=、=、<=、<、!=]与期望值的比较。

  -  **记录数环比波动**

    表级别质量监控指标，判断记录数环比波动范围的指标监控，如可配置[最小波动值,最大波动值]可接受记录数波动范围。

  -  **记录数方差检验**

    表级别质量监控指标，判断记录数方差检验波动范围的指标监控，如可配置[最小波动值,最大波动值]可接受记录数波动范围。

- **准确性**

- -  **数值同比波动监测**

    对数值类型字段值同比年、季度或月度值是否在波动范围内的指标监控。可配置[最小波动值,最大波动值]可接受记录数波动范围。一般用于报表指标等监控。

  -  **数值环比波动监测**

    对数值类型字段值环比[1-30]天值是否在波动范围内的指标监控。可配置[最小波动值,最大波动值]可接受记录数波动范围。一般用于报表指标等监控。

  -  **数值方差波动检验**

    对数值类型字段值方差检验是否在波动范围内的指标监控。可配置[最小波动值,最大波动值]可接受记录数波动范围。一般用于报表指标等监控。

  -  **表逻辑检查**

    表级别质量监控指标，对表两个字段存在逻辑关系是否准确的监控指标。如信用卡当前剩余可用额度<=此次消费金额；还如贷款，起息日应早于贷款放款日期等异常监控。

- **一致性**

- -  **表级别一致性检查**

    表级别质量监控指标，根据提前定义的数据标准，基础元数据字段命名规范，术语命名规则、字段comennt规范、数据类型规范；指标元数据字段命名规范，术语命名规范、字段comennt规范、数据类型规范，计算口径是否统一等规范。对表结构字段、字段comment、数据类型等的是否一致的监控检查。

  -  **交叉验证**

    表级别质量监控指标，判断两张表的主体对象是否一致。		

- **时效性**

- - **数据是否准时产出**

    表级别质量监控指标，数据是否按时产出。如用于决策的报表是否领导们上班前准时看到准确无误的报表。

- **数据剖析**

- -  **最大值检查**

    对数值类型字段的最大值与期望值可配置[>、>=、=、<=、<、!=]比较的监控指标。支持Where条件的自定义谓词条件限制。

  - **最小值检查**

    对数值类型字段的最小值与期望值可配置[>、>=、=、<=、<、!=]比较的监控指标。支持Where条件的自定义谓词条件限制。

  - **平均值检查**

    对数值类型字段的平均值与期望值可配置[>、>=、=、<=、<、!=]比较的监控指标。支持Where条件的自定义谓词条件限制。

  - **汇总值检查**

    对数值类型字段的汇总值与期望值可配置[>、>=、=、<=、<、!=]比较的监控指标。支持Where条件的自定义谓词条件限制。



- **自定义规则检查**

- -  **自定义SQL规则**

    用户写自定义SQL实现的监控规则，但这段SQL结果必须一行一列值，即监测结果是一个值。可配置[>、>=、=、<=、<、!=]与期望值的比较，判断监测结果是否异常。



### 相关注意

一个表只能建一个监控（假设表A是分区表，一级分区字段为pt_d，二级分区字段为pt_h，那么此时能建三个监控任务，即针对整表的，针对按天的，针对按小时的）



考虑到数据质量监控任务会对应一个监控执行历史，目前一个质量监控任务只能被一个数据质量节点引用。



如果数据质量节点运行成功，但有强规则监控异常，节点状态将会更新成失败，如果数据质量节点运行时失败，默认影响下游节点。用户可以设置有强规则影响下游任务，也可以设置没有强规则不影响下游节点



监控任务被数据质量节点引用后，不能删除或更改选取的库表，取消引用后才能修改



表唯一建的异常数目代表有多少记录是存在多条记录。