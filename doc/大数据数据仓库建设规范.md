# 大数据数据仓库建设规范

## 数据层次的划分

![image-20210104101241057](http://image-picgo.test.upcdn.net/img/20210104101241.png)

- ODS：Operational Data Store，操作数据层，在结构上其与源系统的增量或者全量数据基本保持一致。它相当于一个数据准备区，同时又承担着基础数据的记录以及历史变化。其主要作用是把基础数据引入到大数据环境中。

- CDM：Common Data Model，公共维度模型层，又细分为DWD和DWS和DIM、DW。它的主要作用是完成数据加工与整合、建立一致性的维度、构建可复用的面向分析和统计的明细事实表以及汇总公共粒度的指标。
  - DIM：Dimension，维度数据。比如国家代码和国家名、地理位置、中文名、国旗图片等信息就存在DIM层中
  - DWD：Data Warehouse Detail，明细数据层，对数据进行规范化（编码转换，清洗，统一格式，脱敏等），不做表联合。
  - DW：Data Warehouse，主题数据层。又称数据集市或宽表。按照业务划分，如流量、订单、用户等，生成字段比较多的宽表，用于提供后续的业务查询，OLAP分析，数据分发等
  - DWS：Data Warehouse Summary，汇总数据层。

- ADS：Application Data Service，应用数据层。应用层是根据业务需要，由前面数据统计而出的结果，可以直接提供查询展现，或导入至Mysql中使用。



## 数据处理流程架构

![img](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/5313846751/p46104.png)



## 公共规范

### 层次调用约定

应用层应优先调用公共层数据，必须存在中间层数据，不允许应用层跨过中间层从ODS层重复加工数据。一方面，中间层团队应该积极了解应用层数据的建设需求，将公用的数据沉淀到公共层，为其他团队提供数据服务；另一方面，应用层团队也应积极配合中间层团队进行持续的数据公共建设的改造。必须避免出现过度的引用ODS层、不合理的数据复制以及子集合冗余。

- ODS层数据不能被应用层任务引用，中间层不能有沉淀的ODS层数据，必须通过CDM层的视图访问。CDM层视图必须使用调度程序进行封装，保持视图的可维护性与可管理性。
- CDM层任务的深度不宜过大（建议不超过10层）。
- 原则上一个计算任务只允许一个输出表。
- CDM汇总层应优先调用CDM明细层。在调用可累加类指标计算时，CDM汇总层尽量优先调用已经产出的粗粒度汇总层，以避免大量汇总直接从海量的明细数据层计算。
- CDM明细层累计快照事实表优先调用CDM事务型事实表，以保持数据的一致性产出。
- 避免应用层过度引用和依赖CDM层明细数据，需要针对性地建设好CDM公共汇总层。



### 数据类型规范

CDM数据公共层如果是引用ODS层数据，则默认使用ODS层字段的数据类型。其衍生加工数据字段按以下标准执行：

- 金额类及其它小数点数据使用DOUBLE类型。
- 字符类数据使用STRING类型。
- ID类和整形数值使用BIGINT类型。
- 时间类型数据使用STRING类型（如果有特殊的格式要求，可以选择性使用DATETIME类型）。
- 状态使用STRING类型。



### 公共字段定义规范

- 数据统计日期的分区字段按以下标准：
  - 按天分区：**dt(YYYYMMDD)**。
  - 按小时分区：**hh(00-23)**。
  - 按分钟：**mi (00-59)**。
- is_{业务}：表示布尔型数据字段。以**Y**和**N**表示，不允许出现空值域。
- 原则上不需要冗余分区字段。





## 数仓表命名规范

### 通用规范

表名、字段名采用一个下划线分隔词根（示例：clienttype->client_type）。
每部分使用小写英文单词，属于通用字段的必须满足通用字段信息的定义。
表名、字段名需以字母为开头。
表名、字段名最长不超过64个英文字符。

### 表命名规则

![image-20210104111918695](http://image-picgo.test.upcdn.net/img/20210104111918.png)

[]:可选项，可以省略
():多选项，以|分隔，必须选填一项
例如：dwd_m_zy_fee_inc_daily、ods_hd_disman_ypertension



## 数据平台开发规范

### 任务节点设计规范

任务节点命名规范

| 节点类型             | 命名规范                   | 备注                                                         |
| :------------------- | :------------------------- | :----------------------------------------------------------- |
| 数据同步节点导入任务 | imp_ {表名}[_{源库标示}]   | 如果多个源库存在表名重复的情况，可以增加源库标识的后缀。     |
| 数据同步节点导出任务 | exp_ {表名}[_{目标库标示}] | 如果存在多个目标库，可以增加目标库标识的后缀。               |
| 数据处理节点         | etl_{输出表名}             | 多个目标表输出任务时，选定一个主要表名作为节点名。多个任务插入同一张表的不同分区时，可以建一个虚拟目标表任务。 |
| 初始化表节点         | ddl_{输出表}               | 不涉及                                                       |
| Shell节点            | sh_{脚本命名}              | 不涉及                                                       |

- 资源文件命名规范

  资源名称需有后缀表示资源类型，例如**.JAVA**、**.PY**、**.SH**等。

- 任务设计规范

  SQL任务：

  - 每个SQL任务至少有一个输出表。
  - 脚本需支持重跑，例如使用INSERT OVERWRITE等语句，以便在系统错误时，重跑任务不会出现重复数据等脏数据。
  - 代码如果有时间或日期参数，需采用类似`{system.biz.curdate}`的调度参数，以方便调试。
  - 自定义参数，采用**${变量名}**在发布任务时进行配置。变量名即为调度参数。



### 编码规范

- 编写原则
  - 代码行清晰、整齐，具有一定的可观赏性。
  - 代码编写要充分考虑执行速度最优原则。
  - 代码行整体层次分明、结构化强。
  - 代码中应有必要的注释以增强代码的可读性。
  - 规范要求非强制性地约束代码开发人员的代码编写行为。在实际应用中，只要不违反常规要求，允许存在可理解的偏差。
- 基本要求
  - 代码中应用到的所有SQL关键字、保留字都需使用全大写或小写，例如select/SELECT、from/FROM、where/WHERE、and/AND、or/OR、union/UNION、insert/INSERT、delete/DELETE、group/GROUP、having/HAVING、count/COUNT等。不能使用大小写混合的方式，例如Select或seLECT等方式。
  - 代码中应用到的除关键字、保留字之外的代码，都要求使用小写。
  - 四个空格为一个缩进量，所有的缩进均为一个缩进量的整数倍。
  - 禁止使用`SELECT *`操作，所有操作必须明确指定列名。
  - 通常要求对应的括号在同一列上。



### 调度设计

1. 依赖设计

   将ETL抽象为多个相互依赖的代码节点形成上下游依赖关系，要求如下：

   - 一个节点仅产出一张表，一张表仅由一个节点产出。
   - 下游节点的输入数据来自于上游节点的产出数据。
   - 多并行、少串行（在分布式系统下可发挥其优势）。

2. 运行周期

   如果数据研发的场景是在常见T+1离线计算场景，则应将不同调度任务按照实际业务需求，赋予小时、日、周、月和季度等不同的调度粒度。

   **重要说明**：

   - 程序必须支持重跑。
   - 如果SQL语句优化后，单次执行仍超过30分钟，建议拆表重新设计，建议每个节点运行时长不超过1小时。

3. 设置基线：在传统T+1（每日计算的是前一日产生的业务数据）的场景下，数据理应在第二天某个时间点按时产出以支撑BI或其他应用场景，因此应设置如下基线报警策略。

   - 最终产出任务基线：规定产出最终数据的任务必须在公司规定的X点X分完成，否则视为破线（同时推送相应报警）。
   - 中间任务报警：产出最终数据的任务的上游任务应稳定、按时运行完成。如果出现出错、变慢（运行时间明显长于历史过往平均运行时间）等可能影响最终任务完成时间的事件，则应第一时间推送报警给第一任务责任人。

4. 设置优先级：基于有限的计算资源来设置任务优先级，以保证在已有资源被充分调配利用的情况下，可以按照顺序产出数据，保证重要任务的准时产出。

5. 数据流设计

   ETL过程中，数据流向有如下限制：

   - 数据流向仅支持由低到高，即ODS->DWD->DWS->ADS。
   - 数据不能且不能跨层引用、逆向引用。
   - DWS层不同集市的数据不能相互引用，必须沉淀到DWD层。